[{"id":"91987502.c44518","type":"tab","label":"[UI] Pantalla Principal","disabled":false,"info":""},{"id":"e6863b17.8f4f98","type":"tab","label":"[UI] Ajustes","disabled":false,"info":""},{"id":"9cfa07f0.e9ab28","type":"tab","label":"To Serial ESP","disabled":false,"info":""},{"id":"e073d595.09a098","type":"tab","label":"Sistema Rasp","disabled":false,"info":""},{"id":"c7de3eda.30f35","type":"tab","label":"Contador Automatico","disabled":false,"info":""},{"id":"5e440771.0c3d78","type":"tab","label":"ControlRemoto-MQTT","disabled":false,"info":""},{"id":"f93dd7ce.20ff88","type":"serial-port","z":"","serialport":"/dev/ttyAMA0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":true,"responsetimeout":"10000"},{"id":"146169d5.fe0886","type":"serial-port","z":"","serialport":"/dev/ttyS0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false,"responsetimeout":"10000"},{"id":"31aa3dd.89bc2c2","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","waitfor":"","newline":"\\n","bin":"false","out":"char","addchar":"true","responsetimeout":"10000"},{"id":"afa8a771.f724d8","type":"serial-port","z":"","serialport":"/dev/ttyAMA0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":true,"responsetimeout":"10000"},{"id":"9d847c62.ced8f","type":"serial-port","z":"","serialport":"/dev/ttyS0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false,"responsetimeout":"10000"},{"id":"b9d2707a.79eb7","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"115200","databits":"8","parity":"none","stopbits":"1","waitfor":"","newline":"\\n","bin":"false","out":"char","addchar":"false","responsetimeout":"1000"},{"id":"2a5ea82f.6e1f48","type":"ui_base","z":0,"theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"792fc4c5.22850c","type":"ui_group","z":"","name":"Fechador Accidentes","tab":"","disp":true,"width":"15","collapse":false},{"id":"31abe080.0e165","type":"mqtt-broker","z":"","name":"","broker":"web.inventoteca.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"514b0d2f.3730f4","type":"ui_spacer","name":"spacer","group":"1aecb296.35168d","order":1,"width":1,"height":1},{"id":"303ebc11.87ad44","type":"ui_group","z":"","name":"Conteo desde el último accidente","tab":"","disp":true,"width":15,"collapse":false},{"id":"b937733c.4dfb6","type":"ui_group","z":"","name":"Sistema","tab":"","disp":true,"width":"15","collapse":true},{"id":"b4664949.3452b8","type":"ui_group","z":"","name":"Registro Diario","tab":"","disp":true,"width":15,"collapse":false},{"id":"bd736dcd.729a7","type":"ui_group","z":"","name":"Conteos desde el último accidente","tab":"","disp":true,"width":15,"collapse":false},{"id":"123fe0f3.faef6f","type":"ui_group","z":"","name":"Registro Diario","tab":"5bd158b9.1956d8","disp":true,"width":15,"collapse":false},{"id":"5bd158b9.1956d8","type":"ui_tab","z":"","name":"Pantalla Principal","icon":"dashboard","order":1,"disabled":false,"hidden":false},{"id":"1095345e.93b9bc","type":"ui_group","z":"","name":"Fechador Accidentes","tab":"12d7d971.fac037","disp":true,"width":"15","collapse":false},{"id":"ecdaf936.428408","type":"mqtt-broker","z":"","name":"","broker":"web.inventoteca.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"468bb976.418848","type":"ui_group","z":"","name":"Sistema","tab":"12d7d971.fac037","disp":true,"width":"15","collapse":true},{"id":"12d7d971.fac037","type":"ui_tab","z":"","name":"Ajustes","icon":"dashboard","order":2,"disabled":false,"hidden":false},{"id":"401045ac.2ac7ec","type":"ui_group","z":"","name":"Cruz","tab":"12d7d971.fac037","disp":true,"width":"6","collapse":false},{"id":"11194f05.2a6bb9","type":"function","z":"9cfa07f0.e9ab28","name":"Formato Serial Mes","func":"var convertidor\nvar valMes = msg.payload\nvar Moment =  context.global.get('moment');\nvar calendario = global.get('calendario')\nvar valColor\nvar dia = new Moment();\n\n\ndia = ((dia.format('DD'))/1)-1\n//Saco el día actual y lo paso a entero\nvalColor = (calendario[dia])/1\n\n\nconvertidor ='m' +  valMes + ',' + valColor + ')';\nmsg = {payload: convertidor};\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":220,"wires":[["11efb193.c383ae"]]},{"id":"71364868.31ecc","type":"serial out","z":"9cfa07f0.e9ab28","name":"ESP","serial":"b9d2707a.79eb7","x":890,"y":220,"wires":[]},{"id":"ac6f9802.438328","type":"debug","z":"9cfa07f0.e9ab28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":770,"y":140,"wires":[]},{"id":"47451980.4c8cc","type":"function","z":"9cfa07f0.e9ab28","name":"Formato Serial Apagado","func":"var convertidor;\n//var Moment =  context.global.get('moment');\n//var valColor = flow.get('valColor')||0;\nvar s = global.get('s')||0;\n//var fecha = new Moment();\n//global.set('fecha',fecha.format('DD/MM/YYYY, HH:mm:ss'));\n//var msg2 = {payload: fecha.format('DD/MM/YYYY, HH:mm:ss')};\n//var msg3 = {payload: valColor}\n\nconvertidor ='c';\nmsg = {payload: convertidor};\n\nreturn [msg];","outputs":1,"noerr":0,"x":234,"y":352,"wires":[[]]},{"id":"a514d494.b264d8","type":"function","z":"9cfa07f0.e9ab28","name":"Formato Serial Año","func":"var convertidor\nvar valAnio = msg.payload\nvar Moment =  context.global.get('moment');\nvar calendario = global.get('calendario')\nvar valColor\nvar dia = new Moment();\n\n\ndia = ((dia.format('DD'))/1)-1\n//Saco el día actual y lo paso a entero\nvalColor = (calendario[dia])/1\n\n\nconvertidor ='y' +  valAnio + ',' + valColor + ')';\nmsg = {payload: convertidor};\n\nreturn msg","outputs":1,"noerr":0,"x":410,"y":140,"wires":[["11efb193.c383ae","ac6f9802.438328"]]},{"id":"22dfd485.daf32c","type":"function","z":"9cfa07f0.e9ab28","name":"Formato Serial Días Totales","func":"var convertidor;\nvar Moment =  context.global.get('moment');\nvar calendario = global.get('calendario')\nvar valColor\nvar dia = new Moment();\n\n\ndia = ((dia.format('DD'))/1)-1\n//Saco el día actual y lo paso a entero\nvalColor = (calendario[dia])/1\n\nconvertidor ='t' +  msg.payload + ',' + valColor + ')'; //0 Color Blanco\nmsg = {payload: convertidor};\n\nreturn msg","outputs":1,"noerr":0,"x":440,"y":300,"wires":[["11efb193.c383ae"]]},{"id":"b3296459.3f4dd","type":"link in","z":"9cfa07f0.e9ab28","name":"thisIsSerialAño","links":["6ea9c789.03c1e8"],"x":175,"y":140,"wires":[["a514d494.b264d8"]]},{"id":"5535c068.dd855","type":"link in","z":"9cfa07f0.e9ab28","name":"thisIsSerialMes","links":["f852d76c.a6d928"],"x":215,"y":220,"wires":[["11194f05.2a6bb9"]]},{"id":"933f37ea.a772c","type":"link in","z":"9cfa07f0.e9ab28","name":"thisIsSerialFecha","links":["bfb14421.a58ab8","648ef503.eb046c"],"x":495,"y":40,"wires":[["11efb193.c383ae"]]},{"id":"2a896679.3eec12","type":"link in","z":"9cfa07f0.e9ab28","name":"thisIsSerialDíasTotal","links":["7beb3716.ab9bd8","1f4cb1e3.367e8e","6cb71713.94bef8","84da9e8.1fb346"],"x":175,"y":300,"wires":[["22dfd485.daf32c"]]},{"id":"13f68980.3a5f37","type":"link in","z":"9cfa07f0.e9ab28","name":"thisIsSerialApagadoNPX","links":["591b4100.972f7","48602eb1.8d76e","6d84e891.cca248"],"x":79,"y":352,"wires":[["47451980.4c8cc"]]},{"id":"41d4d9a2.cde868","type":"exec","z":"e073d595.09a098","command":"sudo halt ","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":640,"y":180,"wires":[[],[],[]]},{"id":"9e2d4100.de4f9","type":"inject","z":"e073d595.09a098","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":450,"y":180,"wires":[["41d4d9a2.cde868"]]},{"id":"99d80193.5a9e7","type":"serial in","z":"e073d595.09a098","name":"","serial":"b9d2707a.79eb7","x":420,"y":300,"wires":[["deca3383.4a09d"]]},{"id":"deca3383.4a09d","type":"debug","z":"e073d595.09a098","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":640,"y":300,"wires":[]},{"id":"17ac1ebd.6d5801","type":"function","z":"91987502.c44518","name":"global Set Color Fecha","func":"//var valColor = global.get('valColor')||0;\nvar valColor = msg.payload\nglobal.set('valColor',valColor);\n\nmsg = {payload: valColor};\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":200,"wires":[[]]},{"id":"49f43a0b.c8c024","type":"ui_button","z":"91987502.c44518","name":"Registro","group":"123fe0f3.faef6f","order":3,"width":0,"height":0,"passthru":false,"label":"Registrar Incidente del día actual","tooltip":"","color":"","bgcolor":"dark green","icon":"","payload":"valColor,dia","payloadType":"str","topic":"","x":140,"y":280,"wires":[["74c98975.8b55e8"]]},{"id":"168eb692.96eb79","type":"ui_dropdown","z":"91987502.c44518","name":"","label":"Tipo de Incidente","tooltip":"","place":"Incidente","group":"123fe0f3.faef6f","order":2,"width":0,"height":0,"passthru":true,"options":[{"label":"Sin Accidentes","value":"0","type":"str"},{"label":"Casi Accidente","value":"1","type":"str"},{"label":"Primer Auxilio","value":"2","type":"str"},{"label":"No Incapacitante","value":"3","type":"str"},{"label":"Incapacitante","value":"4","type":"str"}],"payload":"","topic":"","x":170,"y":200,"wires":[["17ac1ebd.6d5801"]]},{"id":"78851a50.86edb4","type":"comment","z":"91987502.c44518","name":"Aquí sólo modificarás la fecha actual.","info":"","x":210,"y":60,"wires":[]},{"id":"a506cd96.75a5d","type":"ui_text","z":"91987502.c44518","group":"123fe0f3.faef6f","order":1,"width":0,"height":0,"name":"","label":"Fecha Actual:","format":"{{msg.payload}}","layout":"col-center","x":640,"y":80,"wires":[]},{"id":"2c4b83e4.642a1c","type":"inject","z":"91987502.c44518","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"x":170,"y":120,"wires":[["98766022.de5f9"]]},{"id":"98766022.de5f9","type":"function","z":"91987502.c44518","name":"fecha-actual","func":"var Moment =  context.global.get('moment')\nvar actual =  new Moment()\n\nmsg.payload = actual.format('DD/MM/YY, HH:mm')\n\nreturn msg","outputs":1,"noerr":0,"x":430,"y":120,"wires":[["a506cd96.75a5d","b05bb630.7cb848"]]},{"id":"1839f27b.43545e","type":"ui_text","z":"91987502.c44518","group":"123fe0f3.faef6f","order":3,"width":0,"height":0,"name":"","label":"Días sin accidentes","format":"{{msg.payload}}","layout":"row-spread","x":650,"y":380,"wires":[]},{"id":"fb3d6923.fb6248","type":"link in","z":"91987502.c44518","name":"pantalla_principal","links":["6cb71713.94bef8","84da9e8.1fb346"],"x":495,"y":380,"wires":[["1839f27b.43545e"]]},{"id":"a44d58e3.c37218","type":"ui_date_picker","z":"e6863b17.8f4f98","name":"","label":"Fecha Sistema","group":"1095345e.93b9bc","order":2,"width":0,"height":0,"passthru":true,"topic":"","x":400,"y":600,"wires":[[]]},{"id":"7862a03f.5a903","type":"comment","z":"e6863b17.8f4f98","name":"Parametro para cambio auto de días","info":"\n","x":220,"y":280,"wires":[]},{"id":"2bb0bc2d.ae0b64","type":"ui_button","z":"e6863b17.8f4f98","name":"","group":"468bb976.418848","order":1,"width":0,"height":0,"passthru":false,"label":"Apagar Displays","tooltip":"","color":"","bgcolor":"black","icon":"","payload":"s","payloadType":"str","topic":"","x":400,"y":660,"wires":[[]]},{"id":"a29492c2.ee58","type":"comment","z":"e6863b17.8f4f98","name":"Cambio remoto del numero de días sin accidente","info":"","x":240,"y":60,"wires":[]},{"id":"462eb6e0.0ce788","type":"function","z":"e6863b17.8f4f98","name":"dias-desde","func":"var Moment =  context.global.get('moment')\nvar actual =  new Moment()\nvar cuenta = msg.payload/1\n\n//Se actualiza la fecha de la ultima actualizacion\nactual = actual.format('DD/MM/YY, HH:mm')\nglobal.set('fecha',actual)\n\n//Se guarda el nuevo numero\nglobal.set('numero',cuenta)\n\n\nmsg.payload = cuenta\nreturn msg\n\n\n\n","outputs":1,"noerr":0,"x":450,"y":120,"wires":[["84da9e8.1fb346","f975d3cc.d08d7"]]},{"id":"df1f8fc5.d5026","type":"function","z":"c7de3eda.30f35","name":"dias-desde","func":"// Se agrega la librería de 'moment' a la funcion\nvar Moment =  context.global.get('moment')\n\n// Se crea la variable 'd' para bajar la 'fecha' \n// que es la fecha de la ultima actualización\nvar d  = global.get('fecha')||0\n\n// Se crea la variable cuenta, que baja el 'numero'\n// que es la cantidad de días sin accidentes\nvar cuenta = global.get('numero')||0\n\n// 'actual' almacena la fecha del momento de la consulta\nvar actual =  new Moment()\n\n// 'ultima' sirve para darle formato a la comparación\nvar ultima =  new Moment(d,'DD/MM/YYYY, HH:mm:ss')\n\n// 'dias' almacena la diferencia de días desde\n// la ultima actualización\nvar dias = actual.diff(ultima, 'seconds')\n\n// Se suman los días almacenados en cuenta con los \n// días calculados por la consulta\ndias = dias + cuenta\nglobal.set('numero',dias)\nglobal.set('fecha',actual)\n\nmsg.payload = dias\nreturn msg\n\n\n\n","outputs":1,"noerr":0,"x":450,"y":80,"wires":[["6cb71713.94bef8"]]},{"id":"e1b872f1.30561","type":"inject","z":"c7de3eda.30f35","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"x":250,"y":80,"wires":[["df1f8fc5.d5026","724f7687.a01cf8","f0386ff7.eb8dd","3b49fb10.3f5244"]]},{"id":"6cb71713.94bef8","type":"link out","z":"c7de3eda.30f35","name":"contador","links":["2a896679.3eec12","a4b219d0.744be8","fb3d6923.fb6248","7c79daa.ca8d324"],"x":575,"y":80,"wires":[]},{"id":"3cba0e4f.ded342","type":"inject","z":"e073d595.09a098","name":"","topic":"","payload":"n9,0)","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":370,"y":400,"wires":[[]]},{"id":"84da9e8.1fb346","type":"link out","z":"e6863b17.8f4f98","name":"ajuste_dias","links":["2a896679.3eec12","a4b219d0.744be8","fb3d6923.fb6248"],"x":615,"y":120,"wires":[]},{"id":"f975d3cc.d08d7","type":"ui_text_input","z":"e6863b17.8f4f98","name":"","label":"Dias sin accidentes","tooltip":"","group":"1095345e.93b9bc","order":1,"width":0,"height":0,"passthru":false,"mode":"number","delay":"300","topic":"","x":450,"y":180,"wires":[["462eb6e0.0ce788"]]},{"id":"d58f0171.c276a","type":"mqtt in","z":"5e440771.0c3d78","name":"","topic":"cruzdeseguridad/diastotal/num","qos":"2","datatype":"auto","broker":"ecdaf936.428408","x":170,"y":80,"wires":[["8cb52ce1.02548"]]},{"id":"360271a1.de613e","type":"mqtt in","z":"5e440771.0c3d78","name":"","topic":"cruzdeseguridad/fecha/col","qos":"2","datatype":"auto","broker":"ecdaf936.428408","x":150,"y":160,"wires":[[]]},{"id":"836a3ac2.4b0d78","type":"mqtt out","z":"5e440771.0c3d78","name":"","topic":"cruzdeseguridad/diastotal","qos":"","retain":"","broker":"31abe080.0e165","x":810,"y":80,"wires":[]},{"id":"8cb52ce1.02548","type":"link out","z":"5e440771.0c3d78","name":"mqtt_ajuste_dias","links":["8538e7dc.a5f838"],"x":355,"y":80,"wires":[]},{"id":"8538e7dc.a5f838","type":"link in","z":"e6863b17.8f4f98","name":"","links":["8cb52ce1.02548"],"x":275,"y":120,"wires":[["462eb6e0.0ce788"]]},{"id":"a4b219d0.744be8","type":"link in","z":"5e440771.0c3d78","name":"mqtt_muestra_dias","links":["84da9e8.1fb346","6cb71713.94bef8"],"x":535,"y":80,"wires":[["4f422add.cdf344"]]},{"id":"2e42c772.8f8668","type":"mqtt in","z":"5e440771.0c3d78","name":"","topic":"cruzdeseguridad/refresh","qos":"2","datatype":"auto","broker":"31abe080.0e165","x":150,"y":260,"wires":[["bbb88532.d58148"]]},{"id":"b9376492.9feb18","type":"link in","z":"c7de3eda.30f35","name":"contador_refresh","links":["bbb88532.d58148","b2fac5ff.acce68","648ef503.eb046c"],"x":295,"y":160,"wires":[["df1f8fc5.d5026","724f7687.a01cf8","f0386ff7.eb8dd","3b49fb10.3f5244"]]},{"id":"bbb88532.d58148","type":"link out","z":"5e440771.0c3d78","name":"mqtt_refresh","links":["b9376492.9feb18"],"x":355,"y":260,"wires":[]},{"id":"7c79daa.ca8d324","type":"link in","z":"e6863b17.8f4f98","name":"ajuste_muestra_dias","links":["6cb71713.94bef8"],"x":275,"y":180,"wires":[["f975d3cc.d08d7"]]},{"id":"b20e2548.1ecc48","type":"ui_text_input","z":"e6863b17.8f4f98","name":"","label":"Hora para cambio automático","tooltip":"","group":"1095345e.93b9bc","order":4,"width":0,"height":0,"passthru":false,"mode":"time","delay":"0","topic":"","x":670,"y":340,"wires":[["de73ba57.cda178"]]},{"id":"fd4f972d.023d28","type":"function","z":"e6863b17.8f4f98","name":"cambia_hora_cambio","func":"var Moment =  context.global.get('moment')\n//var zonaHoraria = new Moment(6,'HH')\nvar horaNueva\n\nvar hora = msg.payload\nhoraNueva = new Moment(hora,'HH:mm')\nhora = horaNueva.format('HH:mm')\n\nglobal.set('hora',hora)\n","outputs":1,"noerr":0,"x":720,"y":400,"wires":[[]]},{"id":"4f422add.cdf344","type":"rbe","z":"5e440771.0c3d78","name":"","func":"rbe","gap":"","start":"","inout":"out","property":"payload","x":630,"y":80,"wires":[["836a3ac2.4b0d78"]]},{"id":"24bab0d1.77222","type":"function","z":"e6863b17.8f4f98","name":"muestra_hora_cambio","func":"var Moment =  context.global.get('moment')\n\nvar hora = global.get('hora')\n\n\n\n//msg.payload = hora.format('HH:mm')\n\nmsg.payload = hora\n\nreturn msg\n","outputs":1,"noerr":0,"x":420,"y":340,"wires":[["b20e2548.1ecc48"]]},{"id":"6fe07eee.9d68e","type":"ui_text_input","z":"e6863b17.8f4f98","name":"","label":"Hora sistema","tooltip":"","group":"1095345e.93b9bc","order":3,"width":0,"height":0,"passthru":false,"mode":"time","delay":"300","topic":"","x":590,"y":540,"wires":[[]]},{"id":"b05bb630.7cb848","type":"link out","z":"91987502.c44518","name":"Principal_fecha_actual","links":["cac9789a.92ecc8"],"x":575,"y":140,"wires":[]},{"id":"cac9789a.92ecc8","type":"link in","z":"e6863b17.8f4f98","name":"ajuste_fecha_actual","links":["b05bb630.7cb848"],"x":195,"y":520,"wires":[["a44d58e3.c37218","8dcfd60a.9ee1f8","24bab0d1.77222"]]},{"id":"8dcfd60a.9ee1f8","type":"function","z":"e6863b17.8f4f98","name":"formato-hora","func":"var Moment =  context.global.get('moment')\nvar actual =  new Moment()\n\nmsg.payload = actual.format('HH:mm')\n\nreturn msg","outputs":1,"noerr":0,"x":390,"y":540,"wires":[["6fe07eee.9d68e"]]},{"id":"4fbc1908.cf4cf8","type":"comment","z":"e6863b17.8f4f98","name":"Ajuste para cambio de hora y fecha del sistema","info":"\n","x":260,"y":460,"wires":[]},{"id":"724f7687.a01cf8","type":"function","z":"c7de3eda.30f35","name":"mes-actual","func":"var Moment =  context.global.get('moment')\nvar actual =  new Moment()\nvar mes = global.get('mesActual')\nvar calendario = new Array(31)\n\n\nmsg.payload = actual.format('MM')\n\nif(mes != msg.payload)\n{\n    global.set('mesActual',msg.payload)\n    global.set('calendario',calendario)\n}\n\n\n\nreturn msg","outputs":1,"noerr":0,"x":450,"y":280,"wires":[["f852d76c.a6d928"]]},{"id":"11efb193.c383ae","type":"delay","z":"9cfa07f0.e9ab28","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"50","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":700,"y":220,"wires":[["71364868.31ecc"]]},{"id":"f852d76c.a6d928","type":"link out","z":"c7de3eda.30f35","name":"contador_mes","links":["5535c068.dd855"],"x":595,"y":280,"wires":[]},{"id":"f0386ff7.eb8dd","type":"function","z":"c7de3eda.30f35","name":"anio-actual","func":"var Moment =  context.global.get('moment')\nvar actual =  new Moment()\n\nmsg.payload = actual.format('YY')\n\nreturn msg","outputs":1,"noerr":0,"x":450,"y":340,"wires":[["6ea9c789.03c1e8"]]},{"id":"6ea9c789.03c1e8","type":"link out","z":"c7de3eda.30f35","name":"contador_anio","links":["b3296459.3f4dd"],"x":595,"y":340,"wires":[]},{"id":"3b49fb10.3f5244","type":"function","z":"c7de3eda.30f35","name":"cruz-niveles","func":"var Moment =  context.global.get('moment')\nvar actual = new Moment()\nvar calendario = global.get('calendario')\nvar nivel\nvar formato\n\nfor(var i = 0; i < actual.format('DD')/1 ; i++)\n{\n    nivel = (calendario[i])\n    formato ='n' +  (i+1) + ',' + nivel + ')';\n    node.send({payload:formato})\n    //return msg;\n}\n\nfor( i = actual.format('DD')/1; i < 31 ; i++)\n{\n    formato ='n' +  (i+1) + ',' + 5 + ')';\n    node.send({payload:formato})\n}\n\n\n//","outputs":1,"noerr":0,"x":450,"y":440,"wires":[["bfb14421.a58ab8"]]},{"id":"dc7be5b9.1d3978","type":"comment","z":"e6863b17.8f4f98","name":"Ajuste para modificar niveles de accidentes anteriores a la fecha actual","info":"\n","x":330,"y":760,"wires":[]},{"id":"d268698b.001db8","type":"ui_date_picker","z":"e6863b17.8f4f98","name":"","label":"Día a cambiar","group":"401045ac.2ac7ec","order":0,"width":0,"height":0,"passthru":true,"topic":"","x":220,"y":840,"wires":[["2b9b2c5e.d5f6b4"]]},{"id":"2b9b2c5e.d5f6b4","type":"function","z":"e6863b17.8f4f98","name":"formato-dia","func":"var Moment =  context.global.get('moment')\nvar entrante =  new Moment(msg.payload)\nvar actual = new Moment()\n\n// Si la fecha entrante es menor a la fecha actual\nif(entrante < actual)\n{\n    if(entrante.format('MM') === actual.format('MM'))\n    {\n       msg.payload = entrante.format('DD') \n       global.set('dia',msg.payload)\n       return [msg,null] \n    }\n    else\n    {\n       msg.payload = \"Solo puede modificar el mes actual\"\n       return [null,msg]\n    }\n    \n}\nelse\n{\n    msg.payload = \"La fecha debe ser menor a la actual\"\n    return [null,msg]\n}\n","outputs":2,"noerr":0,"x":430,"y":840,"wires":[[],["5a9947ed.4fcc58"]]},{"id":"5a9947ed.4fcc58","type":"ui_toast","z":"e6863b17.8f4f98","position":"top right","displayTime":"3","highlight":"","sendall":true,"outputs":0,"ok":"OK","cancel":"","topic":"Error","name":"","x":650,"y":840,"wires":[]},{"id":"fb235163.630dc","type":"function","z":"e6863b17.8f4f98","name":"global Set Color Fecha","func":"var valColor = msg.payload\nglobal.set('valColor',valColor);\n\nmsg = {payload: valColor};\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":900,"wires":[[]]},{"id":"c2047088.24511","type":"ui_dropdown","z":"e6863b17.8f4f98","name":"","label":"Tipo de Incidente","tooltip":"","place":"Incidente","group":"401045ac.2ac7ec","order":2,"width":0,"height":0,"passthru":true,"options":[{"label":"Sin Accidentes","value":"0","type":"str"},{"label":"Casi Accidente","value":"1","type":"str"},{"label":"Primer Auxilio","value":"2","type":"str"},{"label":"No Incapacitante","value":"3","type":"str"},{"label":"Incapacitante","value":"4","type":"str"}],"payload":"","topic":"","x":230,"y":900,"wires":[["fb235163.630dc"]]},{"id":"54e3a8af.e8bf68","type":"ui_button","z":"e6863b17.8f4f98","name":"Registro","group":"401045ac.2ac7ec","order":3,"width":0,"height":0,"passthru":false,"label":"Registrar Incidente ","tooltip":"","color":"","bgcolor":"dark green","icon":"","payload":"true","payloadType":"bool","topic":"","x":200,"y":980,"wires":[["af69ef2e.3229f"]]},{"id":"af69ef2e.3229f","type":"function","z":"e6863b17.8f4f98","name":"guardar-en-arreglo","func":"var calendario = global.get('calendario')\nvar dia = global.get('dia')\ndia = dia/1  // Convertir en numerico\n\ncalendario[dia - 1] = global.get('valColor')\n\nglobal.set('calendario',calendario)\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":980,"wires":[["b2fac5ff.acce68"]]},{"id":"bfb14421.a58ab8","type":"link out","z":"c7de3eda.30f35","name":"contador_dia_cruz","links":["933f37ea.a772c"],"x":595,"y":440,"wires":[]},{"id":"b2fac5ff.acce68","type":"link out","z":"e6863b17.8f4f98","name":"ajuste_refresh","links":["b9376492.9feb18"],"x":715,"y":980,"wires":[]},{"id":"74c98975.8b55e8","type":"function","z":"91987502.c44518","name":"formato-actualizacion-global","func":"var Moment =  context.global.get('moment')\nvar formato\nvar calendario = global.get('calendario')\nvar dia = new Moment()\ndia = (dia.format('DD'))/1  // Convertir en numerico\n\n\n\nformato ='n' +  dia + ',' + global.get('valColor') + ')'\nmsg.payload = formato\ncalendario[dia - 1] = global.get('valColor')\nglobal.set('calendario',calendario)\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":280,"wires":[["648ef503.eb046c","30d419fd.0ed4a6"]]},{"id":"648ef503.eb046c","type":"link out","z":"91987502.c44518","name":"ajuste_refresh","links":["933f37ea.a772c","b9376492.9feb18"],"x":575,"y":320,"wires":[]},{"id":"30d419fd.0ed4a6","type":"debug","z":"91987502.c44518","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":630,"y":260,"wires":[]},{"id":"de73ba57.cda178","type":"moment","z":"e6863b17.8f4f98","name":"","topic":"","input":"payload","inputType":"msg","inTz":"America/Mexico_City","adjAmount":"6","adjType":"hours","adjDir":"subtract","format":"","locale":"es_MX","output":"payload","outputType":"msg","outTz":"America/Mexico_City","x":480,"y":400,"wires":[["fd4f972d.023d28"]]}]